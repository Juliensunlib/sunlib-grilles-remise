name: üß™ Sync Subscription Invoices - SANDBOX

on:
  # D√©clenchement manuel pour les tests
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Mode test (ne cr√©e pas r√©ellement les factures)'
        required: false
        type: boolean
        default: false
  
  # D√©clenchement automatique quotidien √† 9h UTC (10h FR hiver, 11h FR √©t√©)
  schedule:
    - cron: '0 9 * * *'

jobs:
  sync-invoices:
    name: Synchronisation Factures Abonnement
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout du code
        uses: actions/checkout@v4
      
      - name: üêç Configuration Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: üì¶ Installation des d√©pendances
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: üîç V√©rification de la configuration
        env:
          AIRTABLE_API_KEY: ${{ secrets.AIRTABLE_API_KEY_SANDBOX }}
          AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID_SANDBOX }}
        run: |
          echo "‚úÖ Configuration valid√©e"
          echo "üìä Base Airtable: ${AIRTABLE_BASE_ID:0:10}..."
          echo "üîë API Key configur√©e: ${AIRTABLE_API_KEY:0:10}..."
      
      - name: üöÄ Synchronisation des factures
        env:
          # Airtable
          AIRTABLE_API_KEY: ${{ secrets.AIRTABLE_API_KEY_SANDBOX }}
          AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID_SANDBOX }}
          AIRTABLE_TABLE_NAME: service_sellsy
          AIRTABLE_GRILLES_TABLE_NAME: grilles_remise
          
          # Sellsy OAuth
          SELLSY_CONSUMER_TOKEN: ${{ secrets.SELLSY_CONSUMER_TOKEN_SANDBOX }}
          SELLSY_CONSUMER_SECRET: ${{ secrets.SELLSY_CONSUMER_SECRET_SANDBOX }}
          SELLSY_USER_TOKEN: ${{ secrets.SELLSY_USER_TOKEN_SANDBOX }}
          SELLSY_USER_SECRET: ${{ secrets.SELLSY_USER_SECRET_SANDBOX }}
          
          # Mode dry-run (optionnel)
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
        run: |
          echo "üéØ D√©marrage de la synchronisation..."
          echo "üìÖ Date: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "üîß Mode: SANDBOX"
          echo "üß™ Dry-run: $DRY_RUN"
          echo ""
          python sync_subscription_invoices.py
      
      - name: üìä R√©sum√© de l'ex√©cution
        if: always()
        run: |
          echo "‚úÖ Workflow termin√©"
          echo "üìÖ Date de fin: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "üîó Logs disponibles dans les √©tapes pr√©c√©dentes"
      
      - name: ‚ùå Notification en cas d'erreur
        if: failure()
        run: |
          echo "::error::‚ùå La synchronisation a √©chou√©"
          echo "::error::V√©rifiez les logs ci-dessus pour plus de d√©tails"
